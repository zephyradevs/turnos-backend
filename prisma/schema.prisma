// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String    @id @default(uuid()) @db.Uuid
  
  // Credenciales de acceso
  email                       String    @unique @db.VarChar(255)
  passwordHash                String    @map("password_hash") @db.VarChar(255)
  
  // Información personal básica
  name                        String    @db.VarChar(255)
  
  // Sistema de verificación de email
  emailVerified               Boolean   @default(false) @map("email_verified")
  emailVerificationCode       String?   @map("email_verification_code") @db.VarChar(6)
  emailVerificationExpiresAt  DateTime? @map("email_verification_expires_at") @db.Timestamptz()
  
  // Sistema de recuperación de contraseña
  passwordResetToken          String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpiresAt      DateTime? @map("password_reset_expires_at") @db.Timestamptz()
  
  // Auditoría y tracking
  lastLogin                   DateTime? @map("last_login") @db.Timestamptz()
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()

  // Relaciones
  business                    Business?

  @@index([email])
  @@index([emailVerificationCode])
  @@index([passwordResetToken])
  @@map("users")
}

// ==========================================
// CONFIGURACIÓN DEL NEGOCIO
// ==========================================

model Business {
  id                          String    @id @default(uuid()) @db.Uuid
  userId                      String    @unique @map("user_id") @db.Uuid
  
  // Información del negocio
  name                        String    @db.VarChar(255)
  adminName                   String    @map("admin_name") @db.VarChar(255)
  phone                       String    @db.VarChar(50)
  address                     String    @db.VarChar(500)
  city                        String    @db.VarChar(100)
  province                    String    @db.VarChar(100)
  logo                        String?   @db.VarChar(500)
  
  // Configuración de horarios globales
  useIndividualSchedule       Boolean   @default(false) @map("use_individual_schedule")
  useIndividualProfessionalSchedule Boolean @default(false) @map("use_individual_professional_schedule")
  globalOpenTime              String?   @map("global_open_time") @db.VarChar(5)
  globalCloseTime             String?   @map("global_close_time") @db.VarChar(5)
  globalDuration              Int?      @map("global_duration")
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  user                        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  professionals               Professional[]
  operatingHours              OperatingHours[]
  services                    Service[]
  bookingPreferences          BookingPreferences?
  communicationSettings       CommunicationSettings?
  clients                     Client[]
  appointments                Appointment[]

  @@index([userId])
  @@map("businesses")
}

model Professional {
  id                          String    @id @default(uuid()) @db.Uuid
  businessId                  String    @map("business_id") @db.Uuid
  externalId                  String    @map("external_id") @db.VarChar(50) // ID del frontend
  
  // Información personal
  firstName                   String    @map("first_name") @db.VarChar(100)
  lastName                    String    @map("last_name") @db.VarChar(100)
  birthDate                   DateTime  @map("birth_date") @db.Date
  dni                         String    @db.VarChar(20)
  description                 String?   @db.Text
  
  // Configuración de horarios individuales
  useIndividualSchedule       Boolean   @default(false) @map("use_individual_schedule")
  globalOpenTime              String?   @map("global_open_time") @db.VarChar(5)
  globalCloseTime             String?   @map("global_close_time") @db.VarChar(5)
  globalDuration              Int?      @map("global_duration")
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  business                    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  schedules                   ProfessionalSchedule[]
  services                    ServiceProfessional[]
  appointments                Appointment[]

  @@unique([businessId, externalId])
  @@unique([businessId, dni])
  @@index([businessId])
  @@map("professionals")
}

model OperatingHours {
  id                          String    @id @default(uuid()) @db.Uuid
  businessId                  String    @map("business_id") @db.Uuid
  
  // Día de la semana (monday, tuesday, etc.)
  dayOfWeek                   String    @map("day_of_week") @db.VarChar(10)
  enabled                     Boolean   @default(true)
  openTime                    String    @map("open_time") @db.VarChar(5)
  closeTime                   String    @map("close_time") @db.VarChar(5)
  duration                    Int       // Duración del turno en minutos
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  business                    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, dayOfWeek])
  @@index([businessId])
  @@map("operating_hours")
}

model ProfessionalSchedule {
  id                          String    @id @default(uuid()) @db.Uuid
  professionalId              String    @map("professional_id") @db.Uuid
  
  // Día de la semana (monday, tuesday, etc.)
  dayOfWeek                   String    @map("day_of_week") @db.VarChar(10)
  enabled                     Boolean   @default(true)
  openTime                    String    @map("open_time") @db.VarChar(5)
  closeTime                   String    @map("close_time") @db.VarChar(5)
  duration                    Int       // Duración del turno en minutos
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  professional                Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, dayOfWeek])
  @@index([professionalId])
  @@map("professional_schedules")
}

model Service {
  id                          String    @id @default(uuid()) @db.Uuid
  businessId                  String    @map("business_id") @db.Uuid
  externalId                  String    @map("external_id") @db.VarChar(50) // ID del frontend
  
  // Información del servicio
  name                        String    @db.VarChar(255)
  duration                    Int       // Duración en minutos
  price                       Decimal?  @db.Decimal(10, 2)
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  business                    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  professionals               ServiceProfessional[]
  appointments                Appointment[]

  @@unique([businessId, externalId])
  @@index([businessId])
  @@map("services")
}

model ServiceProfessional {
  id                          String    @id @default(uuid()) @db.Uuid
  serviceId                   String    @map("service_id") @db.Uuid
  professionalId              String    @map("professional_id") @db.Uuid
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  
  // Relaciones
  service                     Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  professional                Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([serviceId, professionalId])
  @@index([serviceId])
  @@index([professionalId])
  @@map("service_professionals")
}

model BookingPreferences {
  id                          String    @id @default(uuid()) @db.Uuid
  businessId                  String    @unique @map("business_id") @db.Uuid
  
  // Configuración de reservas
  allowCancellation           Boolean   @default(true) @map("allow_cancellation")
  hoursBeforeBooking          Int       @default(24) @map("hours_before_booking")
  maxDaysAhead                Int       @default(30) @map("max_days_ahead")
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  business                    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("booking_preferences")
}

model CommunicationSettings {
  id                          String    @id @default(uuid()) @db.Uuid
  businessId                  String    @unique @map("business_id") @db.Uuid
  
  // Configuración de comunicación
  sendConfirmationEmail       Boolean   @default(true) @map("send_confirmation_email")
  sendReminderEmail           Boolean   @default(true) @map("send_reminder_email")
  reminderHoursBefore         Int       @default(24) @map("reminder_hours_before")
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  business                    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("communication_settings")
}

// ==========================================
// CLIENTES
// ==========================================

model Client {
  id                          String    @id @default(uuid()) @db.Uuid
  businessId                  String    @map("business_id") @db.Uuid
  
  // Información del cliente
  name                        String    @db.VarChar(255)
  email                       String?   @db.VarChar(255)
  phone                       String?   @db.VarChar(50)
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  business                    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointments                Appointment[]

  @@unique([businessId, email])
  @@index([businessId])
  @@index([email])
  @@map("clients")
}

// ==========================================
// TURNOS / CITAS
// ==========================================

model Appointment {
  id                          String    @id @default(uuid()) @db.Uuid
  businessId                  String    @map("business_id") @db.Uuid
  clientId                    String    @map("client_id") @db.Uuid
  professionalId              String    @map("professional_id") @db.Uuid
  serviceId                   String    @map("service_id") @db.Uuid
  
  // Fecha y hora del turno
  date                        DateTime  @db.Date
  startTime                   String    @map("start_time") @db.VarChar(5) // Formato HH:mm
  endTime                     String    @map("end_time") @db.VarChar(5)   // Formato HH:mm
  
  // Duración en minutos (desnormalizado para consultas rápidas)
  duration                    Int
  
  // Precio al momento de la reserva (desnormalizado por si cambia el precio del servicio)
  price                       Decimal?  @db.Decimal(10, 2)
  
  // Estado del turno
  status                      AppointmentStatus @default(PENDING)
  
  // Notas adicionales
  notes                       String?   @db.Text
  
  // Historial de cambios (para auditoría)
  cancelledAt                 DateTime? @map("cancelled_at") @db.Timestamptz()
  cancelledReason             String?   @map("cancelled_reason") @db.Text
  completedAt                 DateTime? @map("completed_at") @db.Timestamptz()
  
  // Notificaciones
  confirmationEmailSent       Boolean   @default(false) @map("confirmation_email_sent")
  reminderEmailSent           Boolean   @default(false) @map("reminder_email_sent")
  
  // Auditoría
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relaciones
  business                    Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client                      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  professional                Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service                     Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([clientId])
  @@index([professionalId])
  @@index([serviceId])
  @@index([date])
  @@index([status])
  @@index([businessId, date])
  @@index([professionalId, date])
  @@map("appointments")
}

enum AppointmentStatus {
  PENDING     // Pendiente de confirmación
  CONFIRMED   // Confirmado
  IN_PROGRESS // En progreso
  COMPLETED   // Completado
  CANCELLED   // Cancelado
  NO_SHOW     // Cliente no asistió
}
